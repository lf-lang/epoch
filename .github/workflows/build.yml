name: Build toolchain

on:
  workflow_call:
    inputs:
      nightly:
        required: false
        type: boolean
        default: false
      lingua-franca-ref:
        type: string
        required: false

  workflow_dispatch:

jobs:
  build-epoch:
    runs-on: ubuntu-latest
    steps:
      - name: Check out epoch repository
        uses: actions/checkout@v3
        with:
          submodules: recursive
          fetch-depth: 0
      - uses: actions/setup-java@v3
        with:  
          distribution: temurin
          java-version: 17
      - name: Check Maven/Java configuration
        run: mvn -version
        shell: bash
      - name: Update `lingua-franca` submodule
        run: |
          ls -l
          cd org.lflang/lingua-franca
          git checkout ${{ inputs.lingua-franca-ref }}
          git pull
          git submodule update
        shell: bash
        if: ${{ inputs.lingua-franca-ref != '' }}
      - name: Commit to the `nightly` branch
        run: |
          git status --porcelain | grep . && git commit -a -m 'Update lingua-franca submodule'
          git push -f origin/nightly
          git switch nightly
          git pull
          if: ${{ inputs.lingua-franca-ref != '' && inputs.nightly == true }}
      - name: Build and package epoch
        run: mvn -U package
        shell: bash
      - name: Deploy nightly release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: 'nightly'
          prerelease: true
          title: "Epoch Nightly"
          files: |
            org.lflang.rca/target/products/*.tar.gz
            org.lflang.rca/target/products/*.zip
            org.lflang.updatesite/target/*.zip
        if: ${{ inputs.nightly == true }}
      - name: Upload Build Artifact (Linux)
        uses: actions/upload-artifact@v2
        with:
          name: Epoch-Linux
          path: org.lflang.rca/target/products/epoch_ide_*-linux.gtk.x86_64.tar.gz
          if-no-files-found: error
          retention-days: 5
        if: ${{ inputs.nightly == false }} 
      - name: Upload Build Artifact (Mac)
        uses: actions/upload-artifact@v2
        with:
          name: Epoch-Mac
          path: org.lflang.rca/target/products/epoch_ide_*-macosx.cocoa.*.tar.gz
          if-no-files-found: error
          retention-days: 5
        if: ${{ inputs.nightly == false }}  
      - name: Upload Build Artifact (Windows)
        uses: actions/upload-artifact@v2
        with:
          name: Epoch-Win
          path: org.lflang.rca/target/products/epoch_ide_*-win32.win32.x86_64.zip
          if-no-files-found: error
          retention-days: 5
        if: ${{ inputs.nightly == false }}
